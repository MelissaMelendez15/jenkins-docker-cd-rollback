services:
  app_blue:
    build: ./app
    environment:
      - APP_VERSION=1.0.0
      - PORT=3000
    ports:
      - "3001:3000"
  app_green: 
    build: ./app
    environment:
      - APP_VERSION=2.0.0
      - PORT=3000
      - HEALTH_FAIL=true
    ports:
      - "3002:3000"
  
  nginx:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/upstream.conf:/etc/nginx/conf.d/upstream.conf:ro
    depends_on:
      - app_blue
      - app_green
  
  jenkins:
    image: jenkins/jenkins:lts-jdk17
    ports:
      - "8081:8080"
      - "50000:50000"
    volumes:
      - jenkins_home:/var/jenkins_home
    restart: unless-stopped
  
  agent_docker:
    build:
      context: .
      dockerfile: jenkins/agent/Dockerfile
    environment:
      - JENKINS_URL=http://jenkins:8080
      - JENKINS_AGENT_NAME=agent-docker
      - JENKINS_SECRET=8b6748e445d697575a98cd0eb4ff3e075fb86b3452c80e1d1728beeac427972c
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - jenkins
    restart: unless-stopped
  
volumes:
  jenkins_home: